FROM python:3.12-slim

# System packages for psycopg binary build
RUN apt-get update && \
    apt-get install -y build-essential libpq-dev git && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /code

# Copy Python project metadata
COPY pyproject.toml poetry.lock* /code/

# Install Poetry + deps (no virtualenv inside container)
RUN pip install --no-cache-dir poetry && \
    poetry config virtualenvs.create false && \
    poetry install --no-interaction --no-root

# Copy source code last for layer caching
COPY . /code
