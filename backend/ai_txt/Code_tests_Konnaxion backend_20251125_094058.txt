===== TOC (20 fichiers) =====
0001  C:\MyCode\Konnaxionv14\backend\konnaxion\ethikos\tests.py
0002  C:\MyCode\Konnaxionv14\backend\konnaxion\keenkonnect\tests.py
0003  C:\MyCode\Konnaxionv14\backend\konnaxion\kollective_intelligence\tests.py
0004  C:\MyCode\Konnaxionv14\backend\konnaxion\konnected\tests.py
0005  C:\MyCode\Konnaxionv14\backend\konnaxion\kreative\tests.py
0006  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\__init__.py
0007  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\api\__init__.py
0008  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\api\test_openapi.py
0009  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\api\test_urls.py
0010  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\api\test_views.py
0011  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\factories.py
0012  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\test_admin.py
0013  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\test_forms.py
0014  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\test_models.py
0015  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\test_tasks.py
0016  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\test_urls.py
0017  C:\MyCode\Konnaxionv14\backend\konnaxion\users\tests\test_views.py
0018  C:\MyCode\Konnaxionv14\backend\tests\__init__.py
0019  C:\MyCode\Konnaxionv14\backend\tests\test_merge_production_dotenvs_in_dotenv.py
0020  C:\MyCode\Konnaxionv14\backend\tests\test_smoke_platform.py
===== END TOC =====


===== BEGIN konnaxion/ethikos/tests.py =====
from django.test import TestCase

# Create your tests here.

===== END konnaxion/ethikos/tests.py =====


===== BEGIN konnaxion/keenkonnect/tests.py =====
from django.test import TestCase

# Create your tests here.

===== END konnaxion/keenkonnect/tests.py =====


===== BEGIN konnaxion/kollective_intelligence/tests.py =====
from django.test import TestCase

# Create your tests here.

===== END konnaxion/kollective_intelligence/tests.py =====


===== BEGIN konnaxion/konnected/tests.py =====
from django.test import TestCase

# Create your tests here.

===== END konnaxion/konnected/tests.py =====


===== BEGIN konnaxion/kreative/tests.py =====
from django.test import TestCase

# Create your tests here.

===== END konnaxion/kreative/tests.py =====


===== BEGIN konnaxion/users/tests/__init__.py =====

===== END konnaxion/users/tests/__init__.py =====


===== BEGIN konnaxion/users/tests/api/__init__.py =====

===== END konnaxion/users/tests/api/__init__.py =====


===== BEGIN konnaxion/users/tests/api/test_openapi.py =====
from http import HTTPStatus

import pytest
from django.urls import reverse


def test_api_docs_accessible_by_admin(admin_client):
    url = reverse("api-docs")
    response = admin_client.get(url)
    assert response.status_code == HTTPStatus.OK


@pytest.mark.django_db
def test_api_docs_not_accessible_by_anonymous_users(client):
    url = reverse("api-docs")
    response = client.get(url)
    assert response.status_code == HTTPStatus.FORBIDDEN


def test_api_schema_generated_successfully(admin_client):
    url = reverse("api-schema")
    response = admin_client.get(url)
    assert response.status_code == HTTPStatus.OK

===== END konnaxion/users/tests/api/test_openapi.py =====


===== BEGIN konnaxion/users/tests/api/test_urls.py =====
from django.urls import resolve
from django.urls import reverse

from konnaxion.users.models import User


def test_user_detail(user: User):
    assert (
        reverse("api:user-detail", kwargs={"username": user.username})
        == f"/api/users/{user.username}/"
    )
    assert resolve(f"/api/users/{user.username}/").view_name == "api:user-detail"


def test_user_list():
    assert reverse("api:user-list") == "/api/users/"
    assert resolve("/api/users/").view_name == "api:user-list"


def test_user_me():
    assert reverse("api:user-me") == "/api/users/me/"
    assert resolve("/api/users/me/").view_name == "api:user-me"

===== END konnaxion/users/tests/api/test_urls.py =====


===== BEGIN konnaxion/users/tests/api/test_views.py =====
import pytest
from rest_framework.test import APIRequestFactory

from konnaxion.users.api.views import UserViewSet
from konnaxion.users.models import User


class TestUserViewSet:
    @pytest.fixture
    def api_rf(self) -> APIRequestFactory:
        return APIRequestFactory()

    def test_get_queryset(self, user: User, api_rf: APIRequestFactory):
        view = UserViewSet()
        request = api_rf.get("/fake-url/")
        request.user = user

        view.request = request

        qs = view.get_queryset()
        # The authenticated user must be in the queryset…
        assert user in qs
        # …and for the /api/users/ endpoint we only expose the current user
        assert qs.count() == 1

    def test_me(self, user: User, api_rf: APIRequestFactory):
        view = UserViewSet()
        request = api_rf.get("/fake-url/")
        request.user = user

        view.request = request

        response = view.me(request)  # type: ignore[call-arg, arg-type, misc]

        assert response.status_code == 200

        data = response.data
        # Existing fields
        assert data["username"] == user.username
        assert data["url"] == f"http://testserver/api/users/{user.username}/"
        assert data["name"] == user.name

        # New field for avatar support in the frontend
        assert "avatar_url" in data
        # Optional: if you enforce a non-empty URL, keep this; otherwise remove it.
        # assert isinstance(data["avatar_url"], str)
        # assert data["avatar_url"] != ""

===== END konnaxion/users/tests/api/test_views.py =====


===== BEGIN konnaxion/users/tests/factories.py =====
from collections.abc import Sequence
from typing import Any

from factory import Faker
from factory import post_generation
from factory.django import DjangoModelFactory

from konnaxion.users.models import User


class UserFactory(DjangoModelFactory[User]):
    username = Faker("user_name")
    email = Faker("email")
    name = Faker("name")

    @post_generation
    def password(self, create: bool, extracted: Sequence[Any], **kwargs):  # noqa: FBT001
        password = (
            extracted
            if extracted
            else Faker(
                "password",
                length=42,
                special_chars=True,
                digits=True,
                upper_case=True,
                lower_case=True,
            ).evaluate(None, None, extra={"locale": None})
        )
        self.set_password(password)

    @classmethod
    def _after_postgeneration(cls, instance, create, results=None):
        """Save again the instance if creating and at least one hook ran."""
        if create and results and not cls._meta.skip_postgeneration_save:
            # Some post-generation hooks ran, and may have modified us.
            instance.save()

    class Meta:
        model = User
        django_get_or_create = ["username"]

===== END konnaxion/users/tests/factories.py =====


===== BEGIN konnaxion/users/tests/test_admin.py =====
import contextlib
from http import HTTPStatus
from importlib import reload

import pytest
from django.contrib import admin
from django.contrib.auth.models import AnonymousUser
from django.urls import reverse
from pytest_django.asserts import assertRedirects

from konnaxion.users.models import User


class TestUserAdmin:
    def test_changelist(self, admin_client):
        url = reverse("admin:users_user_changelist")
        response = admin_client.get(url)
        assert response.status_code == HTTPStatus.OK

    def test_search(self, admin_client):
        url = reverse("admin:users_user_changelist")
        response = admin_client.get(url, data={"q": "test"})
        assert response.status_code == HTTPStatus.OK

    def test_add(self, admin_client):
        url = reverse("admin:users_user_add")
        response = admin_client.get(url)
        assert response.status_code == HTTPStatus.OK

        response = admin_client.post(
            url,
            data={
                "username": "test",
                "password1": "My_R@ndom-P@ssw0rd",
                "password2": "My_R@ndom-P@ssw0rd",
            },
        )
        assert response.status_code == HTTPStatus.FOUND
        assert User.objects.filter(username="test").exists()

    def test_view_user(self, admin_client):
        user = User.objects.get(username="admin")
        url = reverse("admin:users_user_change", kwargs={"object_id": user.pk})
        response = admin_client.get(url)
        assert response.status_code == HTTPStatus.OK

    @pytest.fixture
    def _force_allauth(self, settings):
        settings.DJANGO_ADMIN_FORCE_ALLAUTH = True
        # Reload the admin module to apply the setting change
        import konnaxion.users.admin as users_admin

        with contextlib.suppress(admin.sites.AlreadyRegistered):  # type: ignore[attr-defined]
            reload(users_admin)

    @pytest.mark.django_db
    @pytest.mark.usefixtures("_force_allauth")
    def test_allauth_login(self, rf, settings):
        request = rf.get("/fake-url")
        request.user = AnonymousUser()
        response = admin.site.login(request)

        # The `admin` login view should redirect to the `allauth` login view
        target_url = reverse(settings.LOGIN_URL) + "?next=" + request.path
        assertRedirects(response, target_url, fetch_redirect_response=False)

===== END konnaxion/users/tests/test_admin.py =====


===== BEGIN konnaxion/users/tests/test_forms.py =====
"""Module for all Form Tests."""

from django.utils.translation import gettext_lazy as _

from konnaxion.users.forms import UserAdminCreationForm
from konnaxion.users.models import User


class TestUserAdminCreationForm:
    """
    Test class for all tests related to the UserAdminCreationForm
    """

    def test_username_validation_error_msg(self, user: User):
        """
        Tests UserAdminCreation Form's unique validator functions correctly by testing:
            1) A new user with an existing username cannot be added.
            2) Only 1 error is raised by the UserCreation Form
            3) The desired error message is raised
        """

        # The user already exists,
        # hence cannot be created.
        form = UserAdminCreationForm(
            {
                "username": user.username,
                "password1": user.password,
                "password2": user.password,
            },
        )

        assert not form.is_valid()
        assert len(form.errors) == 1
        assert "username" in form.errors
        assert form.errors["username"][0] == _("This username has already been taken.")

===== END konnaxion/users/tests/test_forms.py =====


===== BEGIN konnaxion/users/tests/test_models.py =====
from konnaxion.users.models import User


def test_user_get_absolute_url(user: User):
    assert user.get_absolute_url() == f"/users/{user.username}/"

===== END konnaxion/users/tests/test_models.py =====


===== BEGIN konnaxion/users/tests/test_tasks.py =====
import pytest
from celery.result import EagerResult

from konnaxion.users.tasks import get_users_count
from konnaxion.users.tests.factories import UserFactory

pytestmark = pytest.mark.django_db


def test_user_count(settings):
    """A basic test to execute the get_users_count Celery task."""
    batch_size = 3
    UserFactory.create_batch(batch_size)
    settings.CELERY_TASK_ALWAYS_EAGER = True
    task_result = get_users_count.delay()
    assert isinstance(task_result, EagerResult)
    assert task_result.result == batch_size

===== END konnaxion/users/tests/test_tasks.py =====


===== BEGIN konnaxion/users/tests/test_urls.py =====
from django.urls import resolve
from django.urls import reverse

from konnaxion.users.models import User


def test_detail(user: User):
    assert (
        reverse("users:detail", kwargs={"username": user.username})
        == f"/users/{user.username}/"
    )
    assert resolve(f"/users/{user.username}/").view_name == "users:detail"


def test_update():
    assert reverse("users:update") == "/users/~update/"
    assert resolve("/users/~update/").view_name == "users:update"


def test_redirect():
    assert reverse("users:redirect") == "/users/~redirect/"
    assert resolve("/users/~redirect/").view_name == "users:redirect"

===== END konnaxion/users/tests/test_urls.py =====


===== BEGIN konnaxion/users/tests/test_views.py =====
from http import HTTPStatus

import pytest
from django.conf import settings
from django.contrib import messages
from django.contrib.auth.models import AnonymousUser
from django.contrib.messages.middleware import MessageMiddleware
from django.contrib.sessions.middleware import SessionMiddleware
from django.http import HttpRequest
from django.http import HttpResponseRedirect
from django.test import RequestFactory
from django.urls import reverse
from django.utils.translation import gettext_lazy as _

from konnaxion.users.forms import UserAdminChangeForm
from konnaxion.users.models import User
from konnaxion.users.tests.factories import UserFactory
from konnaxion.users.views import UserRedirectView
from konnaxion.users.views import UserUpdateView
from konnaxion.users.views import user_detail_view

pytestmark = pytest.mark.django_db


class TestUserUpdateView:
    """
    TODO:
        extracting view initialization code as class-scoped fixture
        would be great if only pytest-django supported non-function-scoped
        fixture db access -- this is a work-in-progress for now:
        https://github.com/pytest-dev/pytest-django/pull/258
    """

    def dummy_get_response(self, request: HttpRequest):
        return None

    def test_get_success_url(self, user: User, rf: RequestFactory):
        view = UserUpdateView()
        request = rf.get("/fake-url/")
        request.user = user

        view.request = request
        assert view.get_success_url() == f"/users/{user.username}/"

    def test_get_object(self, user: User, rf: RequestFactory):
        view = UserUpdateView()
        request = rf.get("/fake-url/")
        request.user = user

        view.request = request

        assert view.get_object() == user

    def test_form_valid(self, user: User, rf: RequestFactory):
        view = UserUpdateView()
        request = rf.get("/fake-url/")

        # Add the session/message middleware to the request
        SessionMiddleware(self.dummy_get_response).process_request(request)
        MessageMiddleware(self.dummy_get_response).process_request(request)
        request.user = user

        view.request = request

        # Initialize the form
        form = UserAdminChangeForm()
        form.cleaned_data = {}
        form.instance = user
        view.form_valid(form)

        messages_sent = [m.message for m in messages.get_messages(request)]
        assert messages_sent == [_("Information successfully updated")]


class TestUserRedirectView:
    def test_get_redirect_url(self, user: User, rf: RequestFactory):
        view = UserRedirectView()
        request = rf.get("/fake-url")
        request.user = user

        view.request = request
        assert view.get_redirect_url() == f"/users/{user.username}/"


class TestUserDetailView:
    def test_authenticated(self, user: User, rf: RequestFactory):
        request = rf.get("/fake-url/")
        request.user = UserFactory()
        response = user_detail_view(request, username=user.username)

        assert response.status_code == HTTPStatus.OK

    def test_not_authenticated(self, user: User, rf: RequestFactory):
        request = rf.get("/fake-url/")
        request.user = AnonymousUser()
        response = user_detail_view(request, username=user.username)
        login_url = reverse(settings.LOGIN_URL)

        assert isinstance(response, HttpResponseRedirect)
        assert response.status_code == HTTPStatus.FOUND
        assert response.url == f"{login_url}?next=/fake-url/"

===== END konnaxion/users/tests/test_views.py =====


===== BEGIN tests/__init__.py =====

===== END tests/__init__.py =====


===== BEGIN tests/test_merge_production_dotenvs_in_dotenv.py =====
from pathlib import Path

import pytest

from merge_production_dotenvs_in_dotenv import merge


@pytest.mark.parametrize(
    ("input_contents", "expected_output"),
    [
        ([], ""),
        ([""], "\n"),
        (["JANE=doe"], "JANE=doe\n"),
        (["SEP=true", "AR=ator"], "SEP=true\nAR=ator\n"),
        (["A=0", "B=1", "C=2"], "A=0\nB=1\nC=2\n"),
        (["X=x\n", "Y=y", "Z=z\n"], "X=x\n\nY=y\nZ=z\n\n"),
    ],
)
def test_merge(
    tmp_path: Path,
    input_contents: list[str],
    expected_output: str,
):
    output_file = tmp_path / ".env"

    files_to_merge = []
    for num, input_content in enumerate(input_contents, start=1):
        merge_file = tmp_path / f".service{num}"
        merge_file.write_text(input_content)
        files_to_merge.append(merge_file)

    merge(output_file, files_to_merge)

    assert output_file.read_text() == expected_output

===== END tests/test_merge_production_dotenvs_in_dotenv.py =====


===== BEGIN tests/test_smoke_platform.py =====
# tests/test_smoke_platform.py
import json
import pytest
from django.urls import reverse
from konnaxion.users.models import User

from konnaxion.ethikos.models import EthikosCategory, EthikosTopic
from konnaxion.users.tasks import get_users_count

@pytest.mark.django_db
def test_platform_smoke(client, admin_client, settings):
    # 0) Admin and anonymous access to API docs
    assert client.get(reverse("api-docs")).status_code == 403  # anonymous
    assert admin_client.get(reverse("api-docs")).status_code == 200  # admin

    # 1) Users: /api/users/me/
    r = admin_client.get(reverse("api:user-me"))
    assert r.status_code == 200
    me = r.json()
    assert "username" in me and me["username"]

    # 2) Ethikos: create fixtures via ORM, then read via API
    admin = User.objects.get(username="admin")
    cat = EthikosCategory.objects.create(name="General", description="g")
    topic = EthikosTopic.objects.create(
        title="Is AI beneficial?",
        description="debate",
        category=cat,
        created_by=admin,
    )
    r = admin_client.get(reverse("api:ethikos-topic-list"))
    assert r.status_code == 200
    assert any(row["title"] == topic.title for row in r.json())

    # 2b) Ethikos stance: POST within allowed range [-3, 3]
    r = admin_client.post(
        reverse("api:ethikos-stance-list"),
        data=json.dumps({"topic": topic.id, "value": 2}),
        content_type="application/json",
    )
    assert r.status_code in (200, 201)

    # 2c) Ethikos argument: POST a pro argument
    r = admin_client.post(
        reverse("api:ethikos-argument-list"),
        data=json.dumps({"topic": topic.id, "content": "Pro argument", "side": "pro"}),
        content_type="application/json",
    )
    assert r.status_code in (200, 201)

    # 3) KonnectED: create a knowledge resource (author set by view)
    r = admin_client.post(
        reverse("api:konnected-resource-list"),
        data=json.dumps({"title": "Doc 1", "type": "doc", "url": "https://example.com/doc"}),
        content_type="application/json",
    )
    assert r.status_code in (200, 201)

    # 4) Kollective Intelligence: create a vote
    r = admin_client.post(
        reverse("api:kollective-vote-list"),
        data=json.dumps({
            "target_type": "ethikos_topic",
            "target_id": topic.id,
            "raw_value": "1.000",
            "weighted_value": "1.000",
        }),
        content_type="application/json",
    )
    assert r.status_code in (200, 201)

    # 5) Kreative: create a gallery (no file upload)
    r = admin_client.post(
        reverse("api:kreative-gallery-list"),
        data=json.dumps({"title": "G1", "description": ""}),
        content_type="application/json",
    )
    assert r.status_code in (200, 201)

    # 6) Celery task runs eagerly
    settings.CELERY_TASK_ALWAYS_EAGER = True
    res = get_users_count.delay()
    assert res.result == User.objects.count()

===== END tests/test_smoke_platform.py =====

